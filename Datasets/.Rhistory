FTE_data <- FTE_data %>%
select(unitid, efrace24, eftotlt, year, efalevel) %>%
filter(efalevel == 1) %>%
mutate(FTE = ifelse(is.na(efrace24), eftotlt, efrace24)) %>%
group_by(unitid, year) %>%
summarise(Total_FTE = sum(FTE))
missing_values <- FTE_data %>% summarize_all(funs(sum(is.na(.))/n()))
missing_values <- gather(missing_values, key = "feature", value = "missing_pct")
missing_values %>%
filter(missing_pct > 0.03) %>%
ggplot(aes(x=reorder(feature,-missing_pct), y = missing_pct)) +
geom_bar(stat="identity",fill="red")+
coord_flip()+theme_bw()
final_regdata <- final_finance %>%
left_join(FTE_data, by = c("unitid","year")) %>%
na.omit()
final_regdata_FTE <- final_regdata
final_regdata_FTE[,!(colnames(final_regdata) %in% c("unitid","year","Total_FTE"))] <- final_regdata[,!(colnames(final_regdata) %in% c("unitid","year","Total_FTE"))] / final_regdata$Total_FTE
final_regdata_FTE <- final_regdata_FTE %>%
filter(Total_FTE > 1000 & general_subsidy > 0)
final_node <- as.character(paste(getwd(),Directory_node, sep = "/")) #location of all of the csv files
Directory_files <- list.files(path = final_node) #creates a list of all the files in the specified path
path <- as.character(paste(Directory_node,Directory_files[[1]], sep = "/")) #1st CSV file location
Directory_data <- read.csv(path, encoding = "UTF-8") #create the dataframe
year <- str_extract_all(Directory_files[[length(Directory_files)]], pattern = "[0-9]{4}") #Years are specified for each file as #### where the first two numbers are last year and third/fourth number are this year.
Directory_data <- Directory_data %>%
mutate(year = unlist(year)) #create year variable in finance_dataset
colnames(Directory_data) <- tolower(colnames(Directory_data))
for(i in 2:length(Directory_files)){
path <- as.character(paste(Directory_node,Directory_files[[i]], sep = "/"))
placeholder <- read.csv(path, encoding = "UTF-8") #create the dataframe
year <- str_extract_all(Directory_files[[i]], pattern = "[0-9]{4}")
placeholder <- placeholder %>%
mutate(year = unlist(year))
colnames(placeholder) <- tolower(colnames(placeholder))
Directory_data <- Directory_data %>%
plyr::rbind.fill(placeholder)
}
Directory_data <- Directory_data %>%
select(unitid, instnm, iclevel, year)
final_regdata <- final_regdata %>%
left_join(Directory_data, by = c("unitid","year")) %>%
filter(iclevel == 1) %>%
mutate(instnm = as.character(instnm)) %>%
filter(!str_detect(tolower(instnm), "(medical)|(medicine)"))
final_regdata_FTE <- final_regdata_FTE %>%
left_join(Directory_data, by = c("unitid","year")) %>%
mutate(instnm = tolower(as.character(instnm))) %>%
filter(iclevel == 1) %>%
filter(!str_detect(tolower(as.character(instnm)), "(medical)|(medicine)"))
ggplot(filter(final_regdata_FTE, general_subsidy >= 0), aes(x=general_subsidy)) +
geom_histogram(aes(y=..density..), colour="black", fill="white")+
geom_density(alpha=.2, fill="#FF6666")
ggplot(filter(final_regdata_FTE, general_subsidy >= 0), aes(x=general_subsidy, color=year, fill=year)) +
geom_histogram(aes(y=..density..), alpha=0.5,
position="identity")+
geom_density(alpha=.2) + facet_grid(year ~ .)
table1::table1(~general_subsidy, data = final_regdata_FTE)
table1::table1(~general_subsidy|year, data=final_regdata_FTE)
View(final_finance)
View(final_regdata)
ggplot(final_regdata_FTE, aes(x=non_instructional_exp, y=general_subsidy, color=year)) +
geom_point() +
geom_smooth()
table1::table1(~general_subsidy, data = final_regdata_FTE)
table1::table1(~general_subsidy|year, data=final_regdata_FTE)
final_finance %>% group_by(year) %>% summarise(n = count())
final_finance %>% group_by(year) %>% summarise(n = count
final_finance %>% group_by(year) %>% summarise(n = count)
final_finance %>% group_by(year) %>% summarise(count)
final_finance %>% group_by(year) %>% summarise(n())
nrow(na.omit(final_finance))
nrow(filter(final_finance, general_subsidy > 0))
nrow(filter(final_finance, Total_FTE > 0))
nrow(filter(final_regdata, Total_FTE > 0))
nrow(filter(final_regdata, Total_FTE > 0 & general_subsidy > 0))
nrow(filter(final_regdata, Total_FTE > 1000 & general_subsidy > 0))
nrow(filter(final_regdata, Total_FTE > 500 & general_subsidy > 0))
nrow(filter(final_regdata,general_subsidy > 0))
finance_data_reg <- finance_data %>%
mutate(gifts_total = private_giftsgrants + contributions,
grants_appr = federal_appropriation + state_appropriations + local_appropriations + federal_grants + state_grants + local_grants) %>%
mutate(other_rev = total_revenues_investmentreturn - investment_return - gifts_total - grants_appr - auxilary_revenue - total_tuitionfees - hospital_revenue) %>%
mutate(non_instructional_exp = total_expense - instruction_expense - academicsupport_expense - studentservices_expense) %>%
mutate(expense_EG = instruction_expense + academicsupport_expense + studentservices_expense + institutionalsupport_expense + net_grant_aid + research_expense + publicservice_expense) %>%
mutate(other_exp = total_expense - instruction_expense - academicsupport_expense - hospital_expense - auxilary_expense - studentservices_expense - interest_expense) %>%
mutate(expense_EGK = expense_EG - research_expense - publicservice_expense) %>%
mutate(net_tuition_rev = total_tuitionfees) %>%
mutate(general_subsidy = expense_EGK - net_tuition_rev - total_studentgrants) %>%
select(unitid, general_subsidy, net_tuition_rev, expense_EGK, expense_EG,investment_return, gifts_total, grants_appr, auxilary_revenue, hospital_revenue, other_rev, non_instructional_exp, hospital_expense, interest_expense, other_exp, total_tuitionfees, year)
missing_values <- finance_data_reg %>% summarize_all(funs(sum(is.na(.))/n()))
missing_values <- gather(missing_values, key = "feature", value = "missing_pct")
missing_values %>%
filter(missing_pct > 0.03) %>%
ggplot(aes(x=reorder(feature,-missing_pct), y = missing_pct)) +
geom_bar(stat="identity",fill="red")+
coord_flip()+theme_bw()
finance_data_reg <- finance_data %>%
mutate(gifts_total = private_giftsgrants + contributions,
grants_appr = federal_appropriation + state_appropriations + local_appropriations + federal_grants + state_grants + local_grants) %>%
mutate(other_rev = total_revenues_investmentreturn - investment_return - gifts_total - grants_appr - auxilary_revenue - total_tuitionfees - hospital_revenue) %>%
mutate(non_instructional_exp = total_expense - instruction_expense - academicsupport_expense - studentservices_expense) %>%
mutate(expense_EG = instruction_expense + academicsupport_expense + studentservices_expense + institutionalsupport_expense + net_grant_aid + research_expense + publicservice_expense) %>%
mutate(other_exp = total_expense - instruction_expense - academicsupport_expense - hospital_expense - auxilary_expense - studentservices_expense - interest_expense) %>%
mutate(expense_EGK = expense_EG - research_expense - publicservice_expense) %>%
mutate(net_tuition_rev = total_tuitionfees) %>%
mutate(general_subsidy = expense_EGK - net_tuition_rev - total_studentgrants) %>%
select(unitid, general_subsidy, net_tuition_rev, expense_EGK, expense_EG,investment_return, gifts_total, grants_appr, auxilary_revenue, hospital_revenue, other_rev, non_instructional_exp, hospital_expense, interest_expense, other_exp, total_tuitionfees, year) %>%
mutate(auxilary_revenue = ifelse(is.na(auxilary_revenue), 0, auxilary_revenue)) %>%
mutate(hospital_revenue = ifelse(is.na(hospital_revenue), 0, hospital_revenue)) %>%
mutate(other_rev = ifelse(is.na(other_rev), 0, other_rev)) %>%
mutate(other_exp = ifelse(is.na(other_exp), 0, other_exp)) %>%
mutate(hospital_expense = ifelse(is.na(hospital_expense), 0, hospital_expense)) %>%
missing_values <- finance_data_reg %>% summarize_all(funs(sum(is.na(.))/n()))
knitr::opts_chunk$set(echo = TRUE, fig.path="images/", results='asis')
knitr::opts_knit$set(root.dir = "~/Desktop/QMSSClasses/QMSSMAThesis/Datasets")
setwd("~/Desktop/QMSSClasses/QMSSMAThesis/Datasets")
library(tidyverse)
library(stargazer)
library(magrittr)
library(qwraps2)
Finance_node <- "NCES/Finance/Data"
Directory_node <- "NCES/Institutional Characteristics/Directory Information/Data"
Fall_node <- "NCES/Institutional Characteristics/Fall Enrollment/Data"
final_node <- as.character(paste(getwd(),Finance_node, sep = "/")) #location of all of the csv files
finance_files <- list.files(path = final_node) #creates a list of all the files in the specified path
path <- as.character(paste(Finance_node,finance_files[[1]], sep = "/")) #1st CSV file location
finance_data <- read.csv(path) #create the dataframe
year <- str_extract_all(finance_files[[length(finance_files)]], pattern = "[0-9]{2}") #Years are specified for each file as #### where the first two numbers are last year and third/fourth number are this year.
year <- paste0("20",unlist(year)[[2]]) #set year equal to 20xx
finance_data <- finance_data %>%
mutate(year = year) #create year variable in finance_dataset
colnames(finance_data) <- tolower(colnames(finance_data))
for(i in 2:length(finance_files)){
path <- as.character(paste(Finance_node,finance_files[[i]], sep = "/"))
placeholder <- read.csv(path) #create the dataframe
year <- str_extract_all(finance_files[[i]], pattern = "[0-9]{2}")
year <- paste0("20",unlist(year)[[2]])
placeholder <- placeholder %>%
mutate(year = year)
colnames(placeholder) <- tolower(colnames(placeholder))
finance_data <- finance_data %>%
plyr::rbind.fill(placeholder)
}
missing_values <- finance_data %>% summarize_all(funs(sum(is.na(.))/n()))
missing_values <- gather(missing_values, key = "feature", value = "missing_pct")
missing_values %>%
filter(missing_pct > 0.03) %>%
ggplot(aes(x=reorder(feature,-missing_pct), y = missing_pct)) +
geom_bar(stat="identity",fill="red")+
coord_flip()+theme_bw()
varlist_path <- paste0(getwd(),"/NCES/Finance/Data Dictionary/Finance_Varlist.xlsx")
varlist <- readxl::read_xlsx(path = varlist_path, sheet = "VarList")
NCES_varnames <- c(tolower(varlist$varname), 'year')
finance_data <- finance_data %>%
dplyr::select_(.dots = NCES_varnames)
colnames(finance_data) <- c(tolower(varlist$tidyName), 'year')
missing_values <- finance_data %>% summarize_all(funs(sum(is.na(.))/n()))
missing_values <- gather(missing_values, key = "feature", value = "missing_pct")
missing_values %>%
filter(missing_pct > 0.03) %>%
ggplot(aes(x=reorder(feature,-missing_pct), y = missing_pct)) +
geom_bar(stat="identity",fill="red")+
coord_flip()+theme_bw()
finance_data_reg <- finance_data %>%
mutate(gifts_total = private_giftsgrants + contributions,
grants_appr = federal_appropriation + state_appropriations + local_appropriations + federal_grants + state_grants + local_grants) %>%
mutate(other_rev = total_revenues_investmentreturn - investment_return - gifts_total - grants_appr - auxilary_revenue - total_tuitionfees - hospital_revenue) %>%
mutate(non_instructional_exp = total_expense - instruction_expense - academicsupport_expense - studentservices_expense) %>%
mutate(expense_EG = instruction_expense + academicsupport_expense + studentservices_expense + institutionalsupport_expense + net_grant_aid + research_expense + publicservice_expense) %>%
mutate(other_exp = total_expense - instruction_expense - academicsupport_expense - hospital_expense - auxilary_expense - studentservices_expense - interest_expense) %>%
mutate(expense_EGK = expense_EG - research_expense - publicservice_expense) %>%
mutate(net_tuition_rev = total_tuitionfees) %>%
mutate(general_subsidy = expense_EGK - net_tuition_rev - total_studentgrants) %>%
select(unitid, general_subsidy, net_tuition_rev, expense_EGK, expense_EG,investment_return, gifts_total, grants_appr, auxilary_revenue, hospital_revenue, other_rev, non_instructional_exp, hospital_expense, interest_expense, other_exp, total_tuitionfees, year) %>%
mutate(auxilary_revenue = ifelse(is.na(auxilary_revenue), 0, auxilary_revenue)) %>%
mutate(hospital_revenue = ifelse(is.na(hospital_revenue), 0, hospital_revenue)) %>%
mutate(other_rev = ifelse(is.na(other_rev), 0, other_rev)) %>%
mutate(other_exp = ifelse(is.na(other_exp), 0, other_exp)) %>%
mutate(hospital_expense = ifelse(is.na(hospital_expense), 0, hospital_expense)) %>%
missing_values <- finance_data_reg %>% summarize_all(funs(sum(is.na(.))/n()))
finance_data_reg <- finance_data %>%
mutate(gifts_total = private_giftsgrants + contributions,
grants_appr = federal_appropriation + state_appropriations + local_appropriations + federal_grants + state_grants + local_grants) %>%
mutate(other_rev = total_revenues_investmentreturn - investment_return - gifts_total - grants_appr - auxilary_revenue - total_tuitionfees - hospital_revenue) %>%
mutate(non_instructional_exp = total_expense - instruction_expense - academicsupport_expense - studentservices_expense) %>%
mutate(expense_EG = instruction_expense + academicsupport_expense + studentservices_expense + institutionalsupport_expense + net_grant_aid + research_expense + publicservice_expense) %>%
mutate(other_exp = total_expense - instruction_expense - academicsupport_expense - hospital_expense - auxilary_expense - studentservices_expense - interest_expense) %>%
mutate(expense_EGK = expense_EG - research_expense - publicservice_expense) %>%
mutate(net_tuition_rev = total_tuitionfees) %>%
mutate(general_subsidy = expense_EGK - net_tuition_rev - total_studentgrants) %>%
select(unitid, general_subsidy, net_tuition_rev, expense_EGK, expense_EG,investment_return, gifts_total, grants_appr, auxilary_revenue, hospital_revenue, other_rev, non_instructional_exp, hospital_expense, interest_expense, other_exp, total_tuitionfees, year) %>%
mutate(auxilary_revenue = ifelse(is.na(auxilary_revenue), 0, auxilary_revenue)) %>%
mutate(hospital_revenue = ifelse(is.na(hospital_revenue), 0, hospital_revenue)) %>%
mutate(other_rev = ifelse(is.na(other_rev), 0, other_rev)) %>%
mutate(other_exp = ifelse(is.na(other_exp), 0, other_exp)) %>%
mutate(hospital_expense = ifelse(is.na(hospital_expense), 0, hospital_expense)) %>%
missing_values <- finance_data_reg %>% summarize_all(funs(sum(is.na(.))/n()))
finance_data_reg <- finance_data %>%
mutate(gifts_total = private_giftsgrants + contributions,
grants_appr = federal_appropriation + state_appropriations + local_appropriations + federal_grants + state_grants + local_grants) %>%
mutate(other_rev = total_revenues_investmentreturn - investment_return - gifts_total - grants_appr - auxilary_revenue - total_tuitionfees - hospital_revenue) %>%
mutate(non_instructional_exp = total_expense - instruction_expense - academicsupport_expense - studentservices_expense) %>%
mutate(expense_EG = instruction_expense + academicsupport_expense + studentservices_expense + institutionalsupport_expense + net_grant_aid + research_expense + publicservice_expense) %>%
mutate(other_exp = total_expense - instruction_expense - academicsupport_expense - hospital_expense - auxilary_expense - studentservices_expense - interest_expense) %>%
mutate(expense_EGK = expense_EG - research_expense - publicservice_expense) %>%
mutate(net_tuition_rev = total_tuitionfees) %>%
mutate(general_subsidy = expense_EGK - net_tuition_rev - total_studentgrants) %>%
select(unitid, general_subsidy, net_tuition_rev, expense_EGK, expense_EG,investment_return, gifts_total, grants_appr, auxilary_revenue, hospital_revenue, other_rev, non_instructional_exp, hospital_expense, interest_expense, other_exp, total_tuitionfees, year)
finance_data_reg <- finance_data_reg %>%
mutate(auxilary_revenue = ifelse(is.na(auxilary_revenue), 0, auxilary_revenue)) %>%
mutate(hospital_revenue = ifelse(is.na(hospital_revenue), 0, hospital_revenue)) %>%
mutate(other_rev = ifelse(is.na(other_rev), 0, other_rev)) %>%
mutate(other_exp = ifelse(is.na(other_exp), 0, other_exp)) %>%
mutate(hospital_expense = ifelse(is.na(hospital_expense), 0, hospital_expense)) %>%
missing_values <- finance_data_reg %>% summarize_all(funs(sum(is.na(.))/n()))
finance_data_reg <- finance_data %>%
mutate(gifts_total = private_giftsgrants + contributions,
grants_appr = federal_appropriation + state_appropriations + local_appropriations + federal_grants + state_grants + local_grants) %>%
mutate(other_rev = total_revenues_investmentreturn - investment_return - gifts_total - grants_appr - auxilary_revenue - total_tuitionfees - hospital_revenue) %>%
mutate(non_instructional_exp = total_expense - instruction_expense - academicsupport_expense - studentservices_expense) %>%
mutate(expense_EG = instruction_expense + academicsupport_expense + studentservices_expense + institutionalsupport_expense + net_grant_aid + research_expense + publicservice_expense) %>%
mutate(other_exp = total_expense - instruction_expense - academicsupport_expense - hospital_expense - auxilary_expense - studentservices_expense - interest_expense) %>%
mutate(expense_EGK = expense_EG - research_expense - publicservice_expense) %>%
mutate(net_tuition_rev = total_tuitionfees) %>%
mutate(general_subsidy = expense_EGK - net_tuition_rev - total_studentgrants) %>%
select(unitid, general_subsidy, net_tuition_rev, expense_EGK, expense_EG,investment_return, gifts_total, grants_appr, auxilary_revenue, hospital_revenue, other_rev, non_instructional_exp, hospital_expense, interest_expense, other_exp, total_tuitionfees, year) %>%
mutate(auxilary_revenue = ifelse(is.na(auxilary_revenue), 0, auxilary_revenue)) %>%
mutate(hospital_revenue = ifelse(is.na(hospital_revenue), 0, hospital_revenue)) %>%
mutate(other_rev = ifelse(is.na(other_rev), 0, other_rev)) %>%
mutate(other_exp = ifelse(is.na(other_exp), 0, other_exp)) %>%
mutate(hospital_expense = ifelse(is.na(hospital_expense), 0, hospital_expense))
missing_values <- finance_data_reg %>% summarize_all(funs(sum(is.na(.))/n()))
missing_values <- gather(missing_values, key = "feature", value = "missing_pct")
missing_values %>%
filter(missing_pct > 0.03) %>%
ggplot(aes(x=reorder(feature,-missing_pct), y = missing_pct)) +
geom_bar(stat="identity",fill="red")+
coord_flip()+theme_bw()
final_finance <- finance_data_reg %>%
na.omit()
final_node <- as.character(paste(getwd(),Fall_node, sep = "/")) #location of all of the csv files
FTE_files <- list.files(path = final_node) #creates a list of all the files in the specified path
path <- as.character(paste(Fall_node,FTE_files[[1]], sep = "/")) #1st CSV file location
FTE_data <- read.csv(path) #create the dataframe
year <- str_extract_all(FTE_files[[length(FTE_files)]], pattern = "[0-9]{4}") #Years are specified for each file as #### where the first two numbers are last year and third/fourth number are this year.
FTE_data <- FTE_data %>%
mutate(year = unlist(year)) #create year variable in finance_dataset
colnames(FTE_data) <- tolower(colnames(FTE_data))
for(i in 2:length(FTE_files)){
path <- as.character(paste(Fall_node,FTE_files[[i]], sep = "/"))
placeholder <- read.csv(path) #create the dataframe
year <- str_extract_all(FTE_files[[i]], pattern = "[0-9]{4}")
placeholder <- placeholder %>%
mutate(year = unlist(year))
colnames(placeholder) <- tolower(colnames(placeholder))
FTE_data <- FTE_data %>%
plyr::rbind.fill(placeholder)
}
missing_values <- FTE_data %>% summarize_all(funs(sum(is.na(.))/n()))
missing_values <- gather(missing_values, key = "feature", value = "missing_pct")
missing_values %>%
filter(missing_pct > 0.03) %>%
ggplot(aes(x=reorder(feature,-missing_pct), y = missing_pct)) +
geom_bar(stat="identity",fill="red")+
coord_flip()+theme_bw()
FTE_data <- FTE_data %>%
select(unitid, efrace24, eftotlt, year, efalevel) %>%
filter(efalevel == 1) %>%
mutate(FTE = ifelse(is.na(efrace24), eftotlt, efrace24)) %>%
group_by(unitid, year) %>%
summarise(Total_FTE = sum(FTE))
missing_values <- FTE_data %>% summarize_all(funs(sum(is.na(.))/n()))
missing_values <- gather(missing_values, key = "feature", value = "missing_pct")
missing_values %>%
filter(missing_pct > 0.03) %>%
ggplot(aes(x=reorder(feature,-missing_pct), y = missing_pct)) +
geom_bar(stat="identity",fill="red")+
coord_flip()+theme_bw()
final_regdata <- final_finance %>%
left_join(FTE_data, by = c("unitid","year")) %>%
na.omit()
final_regdata <- final_finance %>%
left_join(FTE_data, by = c("unitid","year")) %>%
na.omit()
nrow(filter(final_regdata, Total_FTE > 0 & general_subsidy > 0))
nrow(filter(final_regdata, Total_FTE > 1000 & general_subsidy > 0))
nrow(filter(final_regdata, Total_FTE > 100 & general_subsidy > 0))
final_regdata_FTE <- final_regdata
final_regdata_FTE[,!(colnames(final_regdata) %in% c("unitid","year","Total_FTE"))] <- final_regdata[,!(colnames(final_regdata) %in% c("unitid","year","Total_FTE"))] / final_regdata$Total_FTE
mean(final_regdata_FTE$general_subsidy)
mean(final_regdata_FTE$general_subsidy[final_regdata_FTE$Total_FTE > 1000])
final_node <- as.character(paste(getwd(),Directory_node, sep = "/")) #location of all of the csv files
Directory_files <- list.files(path = final_node) #creates a list of all the files in the specified path
path <- as.character(paste(Directory_node,Directory_files[[1]], sep = "/")) #1st CSV file location
Directory_data <- read.csv(path, encoding = "UTF-8") #create the dataframe
year <- str_extract_all(Directory_files[[length(Directory_files)]], pattern = "[0-9]{4}") #Years are specified for each file as #### where the first two numbers are last year and third/fourth number are this year.
Directory_data <- Directory_data %>%
mutate(year = unlist(year)) #create year variable in finance_dataset
colnames(Directory_data) <- tolower(colnames(Directory_data))
for(i in 2:length(Directory_files)){
path <- as.character(paste(Directory_node,Directory_files[[i]], sep = "/"))
placeholder <- read.csv(path, encoding = "UTF-8") #create the dataframe
year <- str_extract_all(Directory_files[[i]], pattern = "[0-9]{4}")
placeholder <- placeholder %>%
mutate(year = unlist(year))
colnames(placeholder) <- tolower(colnames(placeholder))
Directory_data <- Directory_data %>%
plyr::rbind.fill(placeholder)
}
Directory_data <- Directory_data %>%
select(unitid, instnm, iclevel, year)
final_regdata_FTE <- final_regdata_FTE %>%
left_join(Directory_data, by = c("unitid","year"))
nrow(filter(final_regdata_FTE, iclevel == 1))
mean(final_regdata_FTE$general_subsidy[final_regdata_FTE$iclevel == 1])
mean(final_regdata_FTE$general_subsidy[final_regdata_FTE$iclevel = 1])
mean(final_regdata_FTE$general_subsidy[final_regdata_FTE$iclevel == 1])
mean(na.omit(final_regdata_FTE$general_subsidy[final_regdata_FTE$iclevel == 1]))
final_regdata <- final_regdata %>%
left_join(Directory_data, by = c("unitid","year")) %>%
filter(iclevel == 1) %>%
mutate(instnm = as.character(instnm)) %>%
filter(!str_detect(tolower(instnm), "(medical)|(medicine)"))
final_regdata_FTE <- final_regdata_FTE %>%
left_join(Directory_data, by = c("unitid","year")) %>%
mutate(instnm = tolower(as.character(instnm))) %>%
filter(iclevel == 1) %>%
filter(!str_detect(tolower(as.character(instnm)), "(medical)|(medicine)"))
knitr::opts_chunk$set(echo = TRUE, fig.path="images/", results='asis')
knitr::opts_knit$set(root.dir = "~/Desktop/QMSSClasses/QMSSMAThesis/Datasets")
setwd("~/Desktop/QMSSClasses/QMSSMAThesis/Datasets")
library(tidyverse)
library(stargazer)
library(magrittr)
library(qwraps2)
Finance_node <- "NCES/Finance/Data"
Directory_node <- "NCES/Institutional Characteristics/Directory Information/Data"
Fall_node <- "NCES/Institutional Characteristics/Fall Enrollment/Data"
final_node <- as.character(paste(getwd(),Finance_node, sep = "/")) #location of all of the csv files
finance_files <- list.files(path = final_node) #creates a list of all the files in the specified path
path <- as.character(paste(Finance_node,finance_files[[1]], sep = "/")) #1st CSV file location
finance_data <- read.csv(path) #create the dataframe
year <- str_extract_all(finance_files[[length(finance_files)]], pattern = "[0-9]{2}") #Years are specified for each file as #### where the first two numbers are last year and third/fourth number are this year.
year <- paste0("20",unlist(year)[[2]]) #set year equal to 20xx
finance_data <- finance_data %>%
mutate(year = year) #create year variable in finance_dataset
colnames(finance_data) <- tolower(colnames(finance_data))
for(i in 2:length(finance_files)){
path <- as.character(paste(Finance_node,finance_files[[i]], sep = "/"))
placeholder <- read.csv(path) #create the dataframe
year <- str_extract_all(finance_files[[i]], pattern = "[0-9]{2}")
year <- paste0("20",unlist(year)[[2]])
placeholder <- placeholder %>%
mutate(year = year)
colnames(placeholder) <- tolower(colnames(placeholder))
finance_data <- finance_data %>%
plyr::rbind.fill(placeholder)
}
missing_values <- finance_data %>% summarize_all(funs(sum(is.na(.))/n()))
missing_values <- gather(missing_values, key = "feature", value = "missing_pct")
missing_values %>%
filter(missing_pct > 0.03) %>%
ggplot(aes(x=reorder(feature,-missing_pct), y = missing_pct)) +
geom_bar(stat="identity",fill="red")+
coord_flip()+theme_bw()
varlist_path <- paste0(getwd(),"/NCES/Finance/Data Dictionary/Finance_Varlist.xlsx")
varlist <- readxl::read_xlsx(path = varlist_path, sheet = "VarList")
NCES_varnames <- c(tolower(varlist$varname), 'year')
finance_data <- finance_data %>%
dplyr::select_(.dots = NCES_varnames)
colnames(finance_data) <- c(tolower(varlist$tidyName), 'year')
missing_values <- finance_data %>% summarize_all(funs(sum(is.na(.))/n()))
missing_values <- gather(missing_values, key = "feature", value = "missing_pct")
missing_values %>%
filter(missing_pct > 0.03) %>%
ggplot(aes(x=reorder(feature,-missing_pct), y = missing_pct)) +
geom_bar(stat="identity",fill="red")+
coord_flip()+theme_bw()
finance_data_reg <- finance_data %>%
mutate(gifts_total = private_giftsgrants + contributions,
grants_appr = federal_appropriation + state_appropriations + local_appropriations + federal_grants + state_grants + local_grants) %>%
mutate(other_rev = total_revenues_investmentreturn - investment_return - gifts_total - grants_appr - auxilary_revenue - total_tuitionfees - hospital_revenue) %>%
mutate(non_instructional_exp = total_expense - instruction_expense - academicsupport_expense - studentservices_expense) %>%
mutate(expense_EG = instruction_expense + academicsupport_expense + studentservices_expense + institutionalsupport_expense + net_grant_aid + research_expense + publicservice_expense) %>%
mutate(other_exp = total_expense - instruction_expense - academicsupport_expense - hospital_expense - auxilary_expense - studentservices_expense - interest_expense) %>%
mutate(expense_EGK = expense_EG - research_expense - publicservice_expense) %>%
mutate(net_tuition_rev = total_tuitionfees) %>%
mutate(general_subsidy = expense_EGK - net_tuition_rev - total_studentgrants) %>%
select(unitid, general_subsidy, net_tuition_rev, expense_EGK, expense_EG,investment_return, gifts_total, grants_appr, auxilary_revenue, hospital_revenue, other_rev, non_instructional_exp, hospital_expense, interest_expense, other_exp, total_tuitionfees, year) %>%
mutate(auxilary_revenue = ifelse(is.na(auxilary_revenue), 0, auxilary_revenue)) %>%
mutate(hospital_revenue = ifelse(is.na(hospital_revenue), 0, hospital_revenue)) %>%
mutate(other_rev = ifelse(is.na(other_rev), 0, other_rev)) %>%
mutate(other_exp = ifelse(is.na(other_exp), 0, other_exp)) %>%
mutate(hospital_expense = ifelse(is.na(hospital_expense), 0, hospital_expense))
missing_values <- finance_data_reg %>% summarize_all(funs(sum(is.na(.))/n()))
missing_values <- gather(missing_values, key = "feature", value = "missing_pct")
missing_values %>%
filter(missing_pct > 0.03) %>%
ggplot(aes(x=reorder(feature,-missing_pct), y = missing_pct)) +
geom_bar(stat="identity",fill="red")+
coord_flip()+theme_bw()
final_finance <- finance_data_reg %>%
na.omit()
final_node <- as.character(paste(getwd(),Fall_node, sep = "/")) #location of all of the csv files
FTE_files <- list.files(path = final_node) #creates a list of all the files in the specified path
path <- as.character(paste(Fall_node,FTE_files[[1]], sep = "/")) #1st CSV file location
FTE_data <- read.csv(path) #create the dataframe
year <- str_extract_all(FTE_files[[length(FTE_files)]], pattern = "[0-9]{4}") #Years are specified for each file as #### where the first two numbers are last year and third/fourth number are this year.
FTE_data <- FTE_data %>%
mutate(year = unlist(year)) #create year variable in finance_dataset
colnames(FTE_data) <- tolower(colnames(FTE_data))
for(i in 2:length(FTE_files)){
path <- as.character(paste(Fall_node,FTE_files[[i]], sep = "/"))
placeholder <- read.csv(path) #create the dataframe
year <- str_extract_all(FTE_files[[i]], pattern = "[0-9]{4}")
placeholder <- placeholder %>%
mutate(year = unlist(year))
colnames(placeholder) <- tolower(colnames(placeholder))
FTE_data <- FTE_data %>%
plyr::rbind.fill(placeholder)
}
missing_values <- FTE_data %>% summarize_all(funs(sum(is.na(.))/n()))
missing_values <- gather(missing_values, key = "feature", value = "missing_pct")
missing_values %>%
filter(missing_pct > 0.03) %>%
ggplot(aes(x=reorder(feature,-missing_pct), y = missing_pct)) +
geom_bar(stat="identity",fill="red")+
coord_flip()+theme_bw()
FTE_data <- FTE_data %>%
select(unitid, efrace24, eftotlt, year, efalevel) %>%
filter(efalevel == 1) %>%
mutate(FTE = ifelse(is.na(efrace24), eftotlt, efrace24)) %>%
group_by(unitid, year) %>%
summarise(Total_FTE = sum(FTE))
missing_values <- FTE_data %>% summarize_all(funs(sum(is.na(.))/n()))
missing_values <- gather(missing_values, key = "feature", value = "missing_pct")
missing_values %>%
filter(missing_pct > 0.03) %>%
ggplot(aes(x=reorder(feature,-missing_pct), y = missing_pct)) +
geom_bar(stat="identity",fill="red")+
coord_flip()+theme_bw()
final_regdata <- final_finance %>%
left_join(FTE_data, by = c("unitid","year")) %>%
na.omit()
final_regdata_FTE <- final_regdata
final_regdata_FTE[,!(colnames(final_regdata) %in% c("unitid","year","Total_FTE"))] <- final_regdata[,!(colnames(final_regdata) %in% c("unitid","year","Total_FTE"))] / final_regdata$Total_FTE
final_node <- as.character(paste(getwd(),Directory_node, sep = "/")) #location of all of the csv files
Directory_files <- list.files(path = final_node) #creates a list of all the files in the specified path
path <- as.character(paste(Directory_node,Directory_files[[1]], sep = "/")) #1st CSV file location
Directory_data <- read.csv(path, encoding = "UTF-8") #create the dataframe
year <- str_extract_all(Directory_files[[length(Directory_files)]], pattern = "[0-9]{4}") #Years are specified for each file as #### where the first two numbers are last year and third/fourth number are this year.
Directory_data <- Directory_data %>%
mutate(year = unlist(year)) #create year variable in finance_dataset
colnames(Directory_data) <- tolower(colnames(Directory_data))
for(i in 2:length(Directory_files)){
path <- as.character(paste(Directory_node,Directory_files[[i]], sep = "/"))
placeholder <- read.csv(path, encoding = "UTF-8") #create the dataframe
year <- str_extract_all(Directory_files[[i]], pattern = "[0-9]{4}")
placeholder <- placeholder %>%
mutate(year = unlist(year))
colnames(placeholder) <- tolower(colnames(placeholder))
Directory_data <- Directory_data %>%
plyr::rbind.fill(placeholder)
}
Directory_data <- Directory_data %>%
select(unitid, instnm, iclevel, year)
final_regdata <- final_regdata %>%
left_join(Directory_data, by = c("unitid","year")) %>%
filter(iclevel == 1) %>%
mutate(instnm = as.character(instnm)) %>%
filter(!str_detect(tolower(instnm), "(medical)|(medicine)"))
final_regdata_FTE <- final_regdata_FTE %>%
left_join(Directory_data, by = c("unitid","year")) %>%
mutate(instnm = tolower(as.character(instnm))) %>%
filter(iclevel == 1) %>%
filter(!str_detect(tolower(as.character(instnm)), "(medical)|(medicine)"))
ggplot(filter(final_regdata_FTE, general_subsidy >= 0), aes(x=general_subsidy)) +
geom_histogram(aes(y=..density..), colour="black", fill="white")+
geom_density(alpha=.2, fill="#FF6666")
ggplot(final_regdata_FTE, aes(x=general_subsidy)) +
geom_histogram(aes(y=..density..), colour="black", fill="white")+
geom_density(alpha=.2, fill="#FF6666")
ggplot(filter(final_regdata_FTE, general_subsidy >= 0), aes(x=general_subsidy, color=year, fill=year)) +
geom_histogram(aes(y=..density..), alpha=0.5,
position="identity")+
geom_density(alpha=.2) + facet_grid(year ~ .)
ggplot(final_regdata_FTE, aes(x=general_subsidy, color=year, fill=year)) +
geom_histogram(aes(y=..density..), alpha=0.5,
position="identity")+
geom_density(alpha=.2) + facet_grid(year ~ .)
final_regdata_FTE <- final_regdata_FTE %>%
filter(Total_FTE > 500)
ggplot(final_regdata_FTE, aes(x=general_subsidy)) +
geom_histogram(aes(y=..density..), colour="black", fill="white")+
geom_density(alpha=.2, fill="#FF6666")
ggplot(final_regdata_FTE, aes(x=general_subsidy, color=year, fill=year)) +
geom_histogram(aes(y=..density..), alpha=0.5,
position="identity")+
geom_density(alpha=.2) + facet_grid(year ~ .)
table1::table1(~general_subsidy, data = final_regdata_FTE)
table1::table1(~general_subsidy|year, data=final_regdata_FTE)
ggplot(final_regdata_FTE, aes(x=non_instructional_exp, y=general_subsidy, color=year)) +
geom_point() +
geom_smooth()
library(brms)
library(bayesplot)
myprior <- c(prior(normal(0, 10000), class = "Intercept"), prior(normal(0,5), class = "b"), prior(cauchy(0,1), class = "sigma"))
model1 <- brm(data = final_regdata_FTE, family = guassian, formula = general_subsidy ~ 1 + investment_return, prior = myprior, chains = 4, cores = 4)
myprior <- c(prior(normal(0, 10000), class = "Intercept"), prior(normal(0,5), class = "b"), prior(cauchy(0,1), class = "sigma"))
model1 <- brm(data = final_regdata_FTE, family = gaussian, formula = general_subsidy ~ 1 + investment_return, prior = myprior, chains = 4, cores = 4)
plot(model1)
